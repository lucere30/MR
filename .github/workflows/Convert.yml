name: Convert Rules to Clash Format

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0:00 运行
  push:
    paths:
      - 'lucere30/MR/lq/*.list'
      - 'lucere30/MR/lq/*.txt'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Convert rules to Clash format
        run: |
          # 创建输出目录
          mkdir -p lucere30/MR/cat

          # 记录是否有文件被转换的标志
          converted=false

          # 处理 MR/lq 目录下的所有 .list 和 .txt 文件
          for file in lucere30/MR/lq/*.{list,txt}; do
            # 检查文件是否存在
            [ -f "$file" ] || continue
            
            # 标记有文件被处理
            converted=true
            
            # 获取文件名（不含扩展名）
            filename=$(basename "$file" | sed 's/\.[^.]*$//')
            
            # 创建输出文件
            output_file="MR/cat/${filename}.yaml"
            
            # 写入 yaml 头部
            echo "payload:" > "$output_file"
            
            # 处理每一行规则并转换格式
            while IFS= read -r line || [[ -n "$line" ]]; do
              # 跳过空行和注释行
              [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
              
              # 移除可能存在的回车符并去除前后空格
              line=$(echo "$line" | tr -d '\r' | awk '{$1=$1};1')
              
              # 直接写入规则，保持原始格式
              echo "  - ${line}" >> "$output_file"
            done < "$file"
          done
          
          # 将转换状态保存到环境变量中
          echo "CONVERTED=${converted}" >> $GITHUB_ENV

      - name: Commit changes
        if: env.CONVERTED == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add MR/cat/*.yaml
          git diff --staged --quiet || git commit -m "chore: Convert rules to Clash format"
          git push
